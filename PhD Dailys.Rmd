---
title: "Survey Daily Report"
date: "`r format(Sys.time(), '%B %d, %Y %H:%M')`"
output: 
  html_document:
    theme: flatly
    toc: true
    toc_float:
      collapsed: false
    toc_depth: 6
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_file = 'index.html'
    )
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(lubridate)
library(knitr)
library(scales)
library(httr)
library(jsonlite)
library(kableExtra)
library(sf)
library(ggspatial)
library(gridExtra)
library(grid)
library(gtable)
library(prettymapr)

kobo_token <- Sys.getenv("KOBO_TOKEN")

# Household survey
form_id_household <- "a7WdSwwL7Zug9hC98x5PRd"
# Water source survey
form_id_source <- "aDnYgCWxBduEXrC6cFzCP2"

base_url <- "https://kf.kobotoolbox.org/api/v2/assets/"

# Get household data
response_household <- GET(
  paste0(base_url, form_id_household, "/data.json"),
  add_headers(Authorization = paste("Token", kobo_token))
)

data_list_household <- content(response_household, as = "parsed", simplifyDataFrame = TRUE)
household_data <- as.data.frame(data_list_household$results)

names(household_data) <- names(household_data) %>%
  sub(".*/", "", .) %>%
  sub("^_", "", .)

household_data <- household_data[, !duplicated(names(household_data))]

household_data <- household_data %>%
  mutate(start_time = ymd_hms(start_time, tz = "UTC")) %>%
  mutate(end_time = ymd_hms(end_time, tz = "UTC")) %>%
  mutate(survey_date = as.Date(start_time)) %>%
  mutate(date_label = format(survey_date, "%b %d")) %>%
  filter(survey_date >= floor_date(Sys.Date(), "month"))

numeric_vars_household <- c("adult_men", "adult_women", "boys", "girls", "school_age_boys", 
  "school_age_girls", "boys_attend_school", "girls_attend_school",
  "drinking_water_daily_spend", "domestic_water_daily_spend",
  "drinking_walk_time", "drinking_wait_time", "drinking_trips",
  "domestic_walk_time", "domestic_wait_time", "domestic_trips",
  "sources_access", "sources_used", "daily_helpers", "jerrycans_men",
  "jerrycans_women", "jerrycans_boys", "jerrycans_girls", "jerrycans_hired",
  "boys_late_school", "girls_late_school", "stored_amount", "sick_water",
  "injuries_water")

household_data <- household_data %>%
  mutate(across(all_of(numeric_vars_household[numeric_vars_household %in% names(household_data)]), as.numeric))

household_data$community <- factor(household_data$community,
                              levels = c("cockle", "dworzark", "portee"),
                              labels = c("Cockle Bay", "Dworzark", "Portee Rokupa"))

household_data$surveyor_name <- factor(household_data$surveyor_name,
                                  levels = c("abdulaib", "abdulaik", "boboieh", "jamiatu", "musa", "joana", "moses", "joseph", "other"),
                                  labels = c("Abdulai B", "Abdulai K", "Boboieh", "Jamiatu", "Musa", "Joana", "Moses", "Joseph", "Other"))

household_data$survey_month <- factor(household_data$survey_month,
                                 levels = c("november", "december", "january", "february", "march", "april", "may", "june", "july", "august", "september", "october"),
                                 labels = c("November", "December", "January", "February", "March", "April", "May", "June", "July", "August", "September", "October"))

# Get water source data
response_source <- GET(
  paste0(base_url, form_id_source, "/data.json"),
  add_headers(Authorization = paste("Token", kobo_token))
)

data_list_source <- content(response_source, as = "parsed", simplifyDataFrame = TRUE)
source_data <- as.data.frame(data_list_source$results)

names(source_data) <- names(source_data) %>%
  sub(".*/", "", .) %>%
  sub("^_", "", .)

source_data <- source_data[, !duplicated(names(source_data))]

source_data <- source_data %>%
  mutate(start_time = ymd_hms(start_time, tz = "UTC")) %>%
  mutate(end_time = ymd_hms(end_time, tz = "UTC")) %>%
  mutate(survey_date = as.Date(start_time)) %>%
  mutate(date_label = format(survey_date, "%b %d"))%>%
  filter(survey_date >= floor_date(Sys.Date(), "month"))

if("consent" %in% names(source_data)) {
  source_data <- source_data %>% filter(consent == "yes")
}

numeric_vars_source <- c("percent_women_gatherers", "price_per_jerrycan", "price_per_month")

source_data <- source_data %>%
  mutate(across(all_of(numeric_vars_source[numeric_vars_source %in% names(source_data)]), as.numeric))

source_data$community <- factor(source_data$community,
                      levels = c("cockle_bay", "dworzark", "portee_rokupa"),
                      labels = c("Cockle Bay", "Dworzark", "Portee Rokupa"))

source_data$surveyor_name <- factor(source_data$surveyor_name,
                                  levels = c("abdulaib", "abdulaik", "boboieh", "jamiatu", "musa", "joana", "moses", "joseph", "other"),
                                  labels = c("Abdulai B", "Abdulai K", "Boboieh", "Jamiatu", "Musa", "Joana", "Moses", "Joseph", "Other"))

```

```{r}
# Define target surveys per community
targets <- tibble(
  community = c("Portee Rokupa", "Dworzark", "Cockle Bay"),
  target = c(170, 340, 170)
)

# Count completed household surveys by community
completed <- household_data %>%
  count(community, name = "completed")

# Calculate remaining surveys
community_progress <- targets %>%
  left_join(completed, by = "community") %>%
  replace_na(list(completed = 0)) %>%
  mutate(remaining = target - completed)
```

**Portee Rokupa**: `r community_progress$completed[community_progress$community == "Portee Rokupa"]`/`r community_progress$target[community_progress$community == "Portee Rokupa"]` surveys completed, `r community_progress$remaining[community_progress$community == "Portee Rokupa"]` remaining

**Dworzark**: `r community_progress$completed[community_progress$community == "Dworzark"]`/`r community_progress$target[community_progress$community == "Dworzark"]` surveys completed, `r community_progress$remaining[community_progress$community == "Dworzark"]` remaining

**Cockle Bay**: `r community_progress$completed[community_progress$community == "Cockle Bay"]`/`r community_progress$target[community_progress$community == "Cockle Bay"]` surveys completed, `r community_progress$remaining[community_progress$community == "Cockle Bay"]` remaining

# Recent Performance

```{r}
# Get all unique dates
all_dates <- sort(unique(c(household_data$survey_date, source_data$survey_date)), decreasing = TRUE)

household_times <- household_data %>%
  group_by(surveyor_name, survey_date) %>%
  summarise(
    start = min(start_time),
    end = max(end_time),
    n_hh = n(),
    .groups = "drop"
  )

source_times <- source_data %>%
  group_by(surveyor_name, survey_date) %>%
  summarise(
    start = min(start_time),
    end = max(end_time),
    n_source = n(),
    .groups = "drop"
  )

# Combine both to get full time ranges
combined_times_raw <- household_times %>%
  full_join(source_times, by = c("surveyor_name", "survey_date")) %>%
  mutate(
    start = pmin(start.x, start.y, na.rm = TRUE),
    end = pmax(end.x, end.y, na.rm = TRUE),
    n_hh = replace_na(n_hh, 0),
    n_source = replace_na(n_source, 0),
    n_total = n_hh + n_source,
    time_range = paste0(format(start, "%H:%M"), " - ", format(end, "%H:%M"), "<br>(", n_hh, " hh / ", n_source, " ws)")
  ) %>%
  select(surveyor_name, survey_date, time_range, n_total, n_hh, n_source)

week_totals <- household_data %>%
  filter(survey_date >= Sys.Date() - 7) %>%
  count(surveyor_name, name = "hh_week") %>%
  full_join(
    source_data %>%
      filter(survey_date >= Sys.Date() - 7) %>%
      count(surveyor_name, name = "source_week"),
    by = "surveyor_name"
  ) %>%
  replace_na(list(hh_week = 0, source_week = 0))

month_totals <- household_data %>%
  filter(survey_date >= Sys.Date() - 30) %>%
  count(surveyor_name, name = "hh_month") %>%
  full_join(
    source_data %>%
      filter(survey_date >= Sys.Date() - 30) %>%
      count(surveyor_name, name = "source_month"),
    by = "surveyor_name"
  ) %>%
  replace_na(list(hh_month = 0, source_month = 0))

combined_times <- combined_times_raw %>%
  complete(surveyor_name, survey_date = all_dates, fill = list(time_range = "", n_total = 0, n_hh = 0, n_source = 0)) %>%
  left_join(week_totals, by = "surveyor_name") %>%
  left_join(month_totals, by = "surveyor_name") %>%
  replace_na(list(hh_week = 0, source_week = 0, hh_month = 0, source_month = 0)) %>%
  mutate(surveyor_name = factor(surveyor_name, 
                          levels = c("Abdulai K", "Abdulai B", "Jamiatu", "Boboieh", 
                                    "Joseph", "Moses", "Musa", "Joana", "Other"))) %>%
  arrange(surveyor_name)%>%
  filter(rowSums(across(where(is.numeric)), na.rm = TRUE) > 0)

# Grand total
grand_daily <- household_data %>%
  count(survey_date, name = "n_hh") %>%
  full_join(
    source_data %>%
      count(survey_date, name = "n_source"),
    by = "survey_date"
  ) %>%
  replace_na(list(n_hh = 0, n_source = 0))

grand_week <- household_data %>%
  filter(survey_date >= Sys.Date() - 7) %>%
  summarise(hh_week = n()) %>%
  bind_cols(
    source_data %>%
      filter(survey_date >= Sys.Date() - 7) %>%
      summarise(source_week = n())
  ) %>%
  replace_na(list(hh_week = 0, source_week = 0))

grand_month <- household_data %>%
  filter(survey_date >= Sys.Date() - 30) %>%
  summarise(hh_month = n()) %>%
  bind_cols(
    source_data %>%
      filter(survey_date >= Sys.Date() - 30) %>%
      summarise(source_month = n())
  ) %>%
  replace_na(list(hh_month = 0, source_month = 0))

grand_total <- grand_daily %>%
  mutate(
    n_total = NA,
    time_range = paste0("(", n_hh, " hh / ", n_source, " ws)"),
    surveyor_name = "GRAND TOTAL",
    hh_week = grand_week$hh_week,
    source_week = grand_week$source_week,
    hh_month = grand_month$hh_month,
    source_month = grand_month$source_month
  ) %>%
  select(surveyor_name, survey_date, time_range, n_total, hh_week, source_week, hh_month, source_month)

# Portee Rokupa subtotal
portee_daily <- household_data %>%
  filter(community == "Portee Rokupa") %>%
  count(survey_date, name = "n_hh") %>%
  full_join(
    source_data %>%
      filter(community == "Portee Rokupa") %>%
      count(survey_date, name = "n_source"),
    by = "survey_date"
  ) %>%
  replace_na(list(n_hh = 0, n_source = 0))

portee_week <- household_data %>%
  filter(survey_date >= Sys.Date() - 7, community == "Portee Rokupa") %>%
  summarise(hh_week = n()) %>%
  bind_cols(
    source_data %>%
      filter(survey_date >= Sys.Date() - 7, community == "Portee Rokupa") %>%
      summarise(source_week = n())
  ) %>%
  replace_na(list(hh_week = 0, source_week = 0))

portee_month <- household_data %>%
  filter(survey_date >= Sys.Date() - 30, community == "Portee Rokupa") %>%
  summarise(hh_month = n()) %>%
  bind_cols(
    source_data %>%
      filter(survey_date >= Sys.Date() - 30, community == "Portee Rokupa") %>%
      summarise(source_month = n())
  ) %>%
  replace_na(list(hh_month = 0, source_month = 0))

portee_subtotal <- portee_daily %>%
  mutate(
    n_total = NA,
    time_range = paste0("(", n_hh, " hh / ", n_source, " ws)"),
    surveyor_name = "Portee Rokupa Total",
    hh_week = portee_week$hh_week,
    source_week = portee_week$source_week,
    hh_month = portee_month$hh_month,
    source_month = portee_month$source_month
  ) %>%
  select(surveyor_name, survey_date, time_range, n_total, hh_week, source_week, hh_month, source_month)

# Dworzark subtotal
dworzark_daily <- household_data %>%
  filter(community == "Dworzark") %>%
  count(survey_date, name = "n_hh") %>%
  full_join(
    source_data %>%
      filter(community == "Dworzark") %>%
      count(survey_date, name = "n_source"),
    by = "survey_date"
  ) %>%
  replace_na(list(n_hh = 0, n_source = 0))

dworzark_week <- household_data %>%
  filter(survey_date >= Sys.Date() - 7, community == "Dworzark") %>%
  summarise(hh_week = n()) %>%
  bind_cols(
    source_data %>%
      filter(survey_date >= Sys.Date() - 7, community == "Dworzark") %>%
      summarise(source_week = n())
  ) %>%
  replace_na(list(hh_week = 0, source_week = 0))

dworzark_month <- household_data %>%
  filter(survey_date >= Sys.Date() - 30, community == "Dworzark") %>%
  summarise(hh_month = n()) %>%
  bind_cols(
    source_data %>%
      filter(survey_date >= Sys.Date() - 30, community == "Dworzark") %>%
      summarise(source_month = n())
  ) %>%
  replace_na(list(hh_month = 0, source_month = 0))

dworzark_subtotal <- dworzark_daily %>%
  mutate(
    n_total = NA,
    time_range = paste0("(", n_hh, " hh / ", n_source, " ws)"),
    surveyor_name = "Dworzark Total",
    hh_week = dworzark_week$hh_week,
    source_week = dworzark_week$source_week,
    hh_month = dworzark_month$hh_month,
    source_month = dworzark_month$source_month
  ) %>%
  select(surveyor_name, survey_date, time_range, n_total, hh_week, source_week, hh_month, source_month)

# Cockle Bay subtotal
cockle_daily <- household_data %>%
  filter(community == "Cockle Bay") %>%
  count(survey_date, name = "n_hh") %>%
  full_join(
    source_data %>%
      filter(community == "Cockle Bay") %>%
      count(survey_date, name = "n_source"),
    by = "survey_date"
  ) %>%
  replace_na(list(n_hh = 0, n_source = 0))

cockle_week <- household_data %>%
  filter(survey_date >= Sys.Date() - 7, community == "Cockle Bay") %>%
  summarise(hh_week = n()) %>%
  bind_cols(
    source_data %>%
      filter(survey_date >= Sys.Date() - 7, community == "Cockle Bay") %>%
      summarise(source_week = n())
  ) %>%
  replace_na(list(hh_week = 0, source_week = 0))

cockle_month <- household_data %>%
  filter(survey_date >= Sys.Date() - 30, community == "Cockle Bay") %>%
  summarise(hh_month = n()) %>%
  bind_cols(
    source_data %>%
      filter(survey_date >= Sys.Date() - 30, community == "Cockle Bay") %>%
      summarise(source_month = n())
  ) %>%
  replace_na(list(hh_month = 0, source_month = 0))

cockle_subtotal <- cockle_daily %>%
  mutate(
    n_total = NA,
    time_range = paste0("(", n_hh, " hh / ", n_source, " ws)"),
    surveyor_name = "Cockle Bay Total",
    hh_week = cockle_week$hh_week,
    source_week = cockle_week$source_week,
    hh_month = cockle_month$hh_month,
    source_month = cockle_month$source_month
  ) %>%
  select(surveyor_name, survey_date, time_range, n_total, hh_week, source_week, hh_month, source_month)

# Color function (weekend logic, blank for 0 total)
apply_color <- function(text, n_total, date) {
  if (is.na(n_total) || n_total == 0) return("")
  
  is_weekend <- weekdays(date) %in% c("Saturday", "Sunday")
  
  if (is_weekend) {
    if (n_total > 10) {
      paste0('<span style="background-color: #ccffcc; display: block;">', text, '</span>')
    } else {
      text
    }
  } else {
    case_when(
      n_total < 8 ~ paste0('<span style="background-color: #ffcccc; display: block;">', text, '</span>'),
      n_total > 10 ~ paste0('<span style="background-color: #ccffcc; display: block;">', text, '</span>'),
      TRUE ~ text
    )
  }
}

# Limit to first 6 dates (columns 1-2 are Surveyor and Totals, plus 6 dates = 8 columns)
dates_to_show <- all_dates[1:min(4, length(all_dates))]

# Combine counts only (no times, blank for 0)
combined_times_final <- combined_times %>%
  select(surveyor_name, survey_date, n_total, n_hh, n_source,
         hh_week, source_week, hh_month, source_month) %>%
  mutate(
    count_text = ifelse(n_total > 0, paste0("(", n_hh, " hh / ", n_source, " ws)"), "")
  ) %>%
  bind_rows(
    grand_total %>% mutate(count_text = ifelse(n_total > 0, time_range, "")) %>%
      select(surveyor_name, survey_date, n_total, hh_week, source_week, hh_month, source_month, count_text),
    portee_subtotal %>% rename(count_text = time_range),
    dworzark_subtotal %>% rename(count_text = time_range),
    cockle_subtotal %>% rename(count_text = time_range)
  ) %>%
  mutate(
    count_text = mapply(apply_color, count_text, n_total, survey_date),
    totals = paste0(
      "Week: ", hh_week, " hh / ", source_week, " ws<br>",
      "Month: ", hh_month, " hh / ", source_month, " ws"
    ),
    surveyor_name = factor(
      surveyor_name,
      levels = c(
        "GRAND TOTAL",
        "Abdulai K", "Abdulai B", "Portee Rokupa Total",
        "Jamiatu", "Boboieh", "Joseph", "Moses", "Dworzark Total",
        "Musa", "Joana", "Other", "Cockle Bay Total"
      )
    )
  ) %>%
  arrange(surveyor_name) %>%
  select(surveyor_name, totals, survey_date, count_text) %>%
  pivot_wider(
    names_from = survey_date,
    values_from = count_text,
    values_fill = ""
  ) %>%
  select(surveyor_name, totals, all_of(as.character(dates_to_show)))

# Identify Sunday columns
sunday_cols <- which(weekdays(as.Date(dates_to_show)) == "Sunday") + 2

# Render table with vertical lines after Sundays and Totals
tbl <- combined_times_final %>%
  kable(
    col.names = c("Surveyor", "Totals", format(dates_to_show, "%a %b %d")),
    escape = FALSE,
    format = "html",
    align = c("l", "c", rep("c", length(dates_to_show)))
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover"),
    full_width = FALSE,
    position = "left",
    fixed_thead = TRUE
  ) %>%
  row_spec(
    which(combined_times_final$surveyor_name %in%
            c("GRAND TOTAL", "Portee Rokupa Total",
              "Dworzark Total", "Cockle Bay Total")),
    bold = TRUE,
    background = "#f0f0f0",
    extra_css = "white-space: nowrap; vertical-align: middle;"
  ) %>%
  row_spec(0, extra_css = "white-space: nowrap;")%>%
  column_spec(2:ncol(combined_times_final), extra_css = "white-space: nowrap; vertical-align: middle;") %>%
  column_spec(2, extra_css = "border-right: 2px solid black; white-space: nowrap; vertical-align: middle;")

# Add right border after Sundays
for (col in sunday_cols) {
  tbl <- tbl %>% column_spec(col, extra_css = "border-left: 2px solid black; white-space: nowrap; vertical-align: middle;")
}

tbl
```

# Mapping

## Portee Rokupa Map
```{r, fig.height=10}
# Read the shapefile
portee_shapefile <- st_read("shapefiles/PorteeRokupa.shp", quiet = TRUE)

# Transform shapefile to WGS84 if needed
portee_shapefile_wgs84 <- st_transform(portee_shapefile, crs = 4326)

# Combine household and water source data for Portee Rokupa
portee_surveys <- bind_rows(
  household_data %>% 
    filter(community == "Portee Rokupa") %>%
    select(community, survey_date, surveyor_name, gps_location) %>%
    mutate(survey_type = "Household"),
  source_data %>% 
    filter(community == "Portee Rokupa") %>%
    select(community, survey_date, surveyor_name, gps_location) %>%
    mutate(survey_type = "Water Source")
) %>%
  filter(!is.na(gps_location)) %>%
  separate(gps_location, into = c("latitude", "longitude", "altitude", "accuracy"), 
           sep = " ", remove = FALSE, convert = TRUE) %>%
  filter(!is.na(latitude), !is.na(longitude)) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

# Transform to a projected CRS for distance calculation (UTM zone for Sierra Leone)
portee_surveys_utm <- st_transform(portee_surveys, crs = 32628)
portee_shapefile_utm <- st_transform(portee_shapefile_wgs84, crs = 32628)

# Calculate distance from each point to the shapefile boundary
distances <- st_distance(portee_surveys_utm, portee_shapefile_utm)

# Filter points within 100m of the shapefile
portee_surveys_filtered <- portee_surveys[as.numeric(distances) <= 100, ]

# Continue with the rest of the code using filtered data
portee_surveys_filtered <- portee_surveys_filtered %>%
  mutate(
    day_name = factor(weekdays(survey_date), 
                     levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
    surveyor_type = case_when(
      surveyor_name == "Abdulai K" ~ "Abdulai K",
      surveyor_name == "Abdulai B" ~ "Abdulai B",
      TRUE ~ "Other Surveyor"
    ),
    outline_color = case_when(
      surveyor_name == "Abdulai K" ~ "black",
      surveyor_name == "Abdulai B" ~ "white",
      TRUE ~ "gray"
    ),
    is_recent = survey_date >= Sys.Date() - 7,
    alpha_value = ifelse(is_recent, 1, 0.7),
    size_value = ifelse(is_recent, 3, 2)
  )

# Define day colors (rainbow order: red through purple, grey for Sunday)
day_colors <- c(
  "Monday" = "#FF0000",      # Red
  "Tuesday" = "#FF7F00",     # Orange
  "Wednesday" = "#FFFF00",   # Yellow
  "Thursday" = "#00FF00",    # Green
  "Friday" = "#0000FF",      # Blue
  "Saturday" = "#8B00FF",    # Purple
  "Sunday" = "#808080"       # Grey
)

# Define shapes for survey types
survey_shapes <- c("Household" = 21, "Water Source" = 24)

# Define outline colors
outline_colors <- c("Abdulai K" = "black", "Abdulai B" = "white", "Other Surveyor" = "gray")

# Portee Rokupa map
ggplot() +
  annotation_map_tile(type = "osm", zoomin = 0, progress = "none") +
  geom_sf(data = portee_shapefile_wgs84, fill = NA, color = "black", linewidth = 1) +
  geom_sf(data = portee_surveys_filtered, aes(fill = day_name, shape = survey_type, color = surveyor_type, alpha = alpha_value, size = size_value), 
          stroke = 1) +
  scale_fill_manual(values = day_colors) +
  scale_shape_manual(values = survey_shapes) +
  scale_color_manual(values = outline_colors) +
  scale_alpha_identity() +
  scale_size_identity() +
  labs(title = "All Surveys in Portee Rokupa", fill = "Day", shape = "Survey Type", color = "Surveyor") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()) +
  guides(
    fill = guide_legend(override.aes = list(shape = 21, color = "black", size = 3, alpha = 1, stroke = 1)),
    shape = guide_legend(override.aes = list(fill = "gray", color = "black", size = 3, alpha = 1, stroke = 1)),
    color = guide_legend(override.aes = list(fill = "gray", shape = 21, size = 3, alpha = 1, stroke = 1))
  )
```

## Dworzark Map

```{r, fig.height=10, fig.width=8}
# Read the shapefile
dworzark_shapefile <- st_read("shapefiles/Dworzark.shp", quiet = TRUE)
# Transform shapefile to WGS84 if needed
dworzark_shapefile_wgs84 <- st_transform(dworzark_shapefile, crs = 4326)

# Get household data for Dworzark
dworzark_households <- household_data %>% 
  filter(community == "Dworzark") %>%
  select(community, survey_date, surveyor_name, gps_location) %>%
  mutate(survey_type = "Household") %>%
  filter(!is.na(gps_location)) %>%
  separate(gps_location, into = c("latitude", "longitude", "altitude", "accuracy"), 
           sep = " ", remove = FALSE, convert = TRUE) %>%
  filter(!is.na(latitude), !is.na(longitude)) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

# Transform to UTM for distance calculation
dworzark_households_utm <- st_transform(dworzark_households, crs = 32628)
dworzark_shapefile_utm <- st_transform(dworzark_shapefile_wgs84, crs = 32628)

# Calculate distance and filter households within 100m
distances <- st_distance(dworzark_households_utm, dworzark_shapefile_utm)
dworzark_households_filtered <- dworzark_households[as.numeric(distances) <= 100, ]

# Get all water source data for Dworzark (no filtering)
dworzark_sources <- source_data %>% 
  filter(community == "Dworzark") %>%
  select(community, survey_date, surveyor_name, gps_location) %>%
  mutate(survey_type = "Water Source") %>%
  filter(!is.na(gps_location)) %>%
  separate(gps_location, into = c("latitude", "longitude", "altitude", "accuracy"), 
           sep = " ", remove = FALSE, convert = TRUE) %>%
  filter(!is.na(latitude), !is.na(longitude)) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

# Combine filtered households with all water sources
dworzark_surveys <- bind_rows(dworzark_households_filtered, dworzark_sources) %>%
  mutate(
    day_name = factor(weekdays(survey_date), 
                     levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
    surveyor_type = case_when(
      surveyor_name == "Jamiatu" ~ "Jamiatu",
      surveyor_name == "Boboieh" ~ "Boboieh",
      surveyor_name == "Joseph" ~ "Joseph",
      surveyor_name == "Moses" ~ "Moses",
      TRUE ~ "Other Surveyor"
    ),
    outline_color = case_when(
      surveyor_name == "Jamiatu" ~ "black",
      surveyor_name == "Boboieh" ~ "white",
      surveyor_name == "Joseph" ~ "blue",
      surveyor_name == "Moses" ~ "red",
      TRUE ~ "gray"
    ),
    is_recent = survey_date >= Sys.Date() - 7,
    alpha_value = ifelse(is_recent, 1, 0.7),
    size_value = ifelse(is_recent, 3, 2)
  )

# Define day colors (rainbow order: red through purple, grey for Sunday)
day_colors <- c(
  "Monday" = "#FF0000",      # Red
  "Tuesday" = "#FF7F00",     # Orange
  "Wednesday" = "#FFFF00",   # Yellow
  "Thursday" = "#00FF00",    # Green
  "Friday" = "#0000FF",      # Blue
  "Saturday" = "#8B00FF",    # Purple
  "Sunday" = "#808080"       # Grey
)

# Define shapes for survey types
survey_shapes <- c("Household" = 21, "Water Source" = 24)

# Define outline colors
outline_colors <- c("Jamiatu" = "black", "Boboieh" = "white", "Joseph" = "blue", "Moses" = "red", "Other Surveyor" = "gray")

# Dworzark map
ggplot() +
  annotation_map_tile(type = "osm", zoomin = 0, progress = "none") +
  geom_sf(data = dworzark_shapefile_wgs84, fill = NA, color = "black", linewidth = 1) +
  geom_sf(data = dworzark_surveys, aes(fill = day_name, shape = survey_type, color = surveyor_type, alpha = alpha_value, size = size_value), 
          stroke = 1) +
  scale_fill_manual(values = day_colors) +
  scale_shape_manual(values = survey_shapes) +
  scale_color_manual(values = outline_colors) +
  scale_alpha_identity() +
  scale_size_identity() +
  labs(title = "All Surveys in Dworzark", fill = "Day", shape = "Survey Type", color = "Surveyor") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()) +
  guides(
    fill = guide_legend(override.aes = list(shape = 21, color = "black", size = 3, alpha = 1, stroke = 1)),
    shape = guide_legend(override.aes = list(fill = "gray", color = "black", size = 3, alpha = 1, stroke = 1)),
    color = guide_legend(override.aes = list(fill = "gray", shape = 21, size = 3, alpha = 1, stroke = 1))
  )
```

## Cockle Bay Map

```{r, fig.height=10}
# Read the shapefile
cockle_shapefile <- st_read("shapefiles/CockleBay.shp", quiet = TRUE)

# Combine household and water source data for Cockle Bay
cockle_surveys <- bind_rows(
  household_data %>% 
    filter(community == "Cockle Bay") %>%
    select(community, survey_date, surveyor_name, gps_location) %>%
    mutate(survey_type = "Household"),
  source_data %>% 
    filter(community == "Cockle Bay") %>%
    select(community, survey_date, surveyor_name, gps_location) %>%
    mutate(survey_type = "Water Source")
) %>%
  filter(!is.na(gps_location)) %>%
  separate(gps_location, into = c("latitude", "longitude", "altitude", "accuracy"), 
           sep = " ", remove = FALSE, convert = TRUE) %>%
  filter(!is.na(latitude), !is.na(longitude)) %>%
  mutate(
    day_name = factor(weekdays(survey_date), 
                     levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
    surveyor_type = ifelse(surveyor_name == "Musa", "Musa", "Other Surveyor"),
    outline_color = ifelse(surveyor_name == "Musa", "black", "white"),
    is_recent = survey_date >= Sys.Date() - 7,
    alpha_value = ifelse(is_recent, 1, 0.7),
    size_value = ifelse(is_recent, 3, 2)
  ) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

# Define day colors (rainbow order: red through purple, grey for Sunday)
day_colors <- c(
  "Monday" = "#FF0000",      # Red
  "Tuesday" = "#FF7F00",     # Orange
  "Wednesday" = "#FFFF00",   # Yellow
  "Thursday" = "#00FF00",    # Green
  "Friday" = "#0000FF",      # Blue
  "Saturday" = "#8B00FF",    # Purple
  "Sunday" = "#808080"       # Grey
)

# Define shapes for survey types
survey_shapes <- c("Household" = 21, "Water Source" = 24)

# Define outline colors
outline_colors <- c("Musa" = "black", "Other Surveyor" = "white")

# Cockle Bay map
ggplot() +
  annotation_map_tile(type = "osm", zoomin = 0, progress = "none") +
  geom_sf(data = cockle_shapefile, fill = NA, color = "black", linewidth = 1) +
  geom_sf(data = cockle_surveys, aes(fill = day_name, shape = survey_type, color = surveyor_type, alpha = alpha_value, size = size_value), 
          stroke = 1) +
  scale_fill_manual(values = day_colors) +
  scale_shape_manual(values = survey_shapes) +
  scale_color_manual(values = outline_colors) +
  scale_alpha_identity() +
  scale_size_identity() +
  labs(title = "All Surveys in Cockle Bay", fill = "Day", shape = "Survey Type", color = "Surveyor") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()) +
  guides(
    fill = guide_legend(override.aes = list(shape = 21, color = "black", size = 3, alpha = 1, stroke = 1)),
    shape = guide_legend(override.aes = list(fill = "gray", color = "black", size = 3, alpha = 1, stroke = 1)),
    color = guide_legend(override.aes = list(fill = "gray", shape = 21, size = 3, alpha = 1, stroke = 1))
  )
```

# Monthly Performance

```{r}
# Get all unique dates
all_dates <- sort(unique(c(household_data$survey_date, source_data$survey_date)), decreasing = FALSE)

household_times <- household_data %>%
  group_by(surveyor_name, survey_date) %>%
  summarise(
    start = min(start_time),
    end = max(end_time),
    n_hh = n(),
    .groups = "drop"
  )

source_times <- source_data %>%
  group_by(surveyor_name, survey_date) %>%
  summarise(
    start = min(start_time),
    end = max(end_time),
    n_source = n(),
    .groups = "drop"
  )

# Combine both to get full time ranges
combined_times_raw <- household_times %>%
  full_join(source_times, by = c("surveyor_name", "survey_date")) %>%
  mutate(
    start = pmin(start.x, start.y, na.rm = TRUE),
    end = pmax(end.x, end.y, na.rm = TRUE),
    n_hh = replace_na(n_hh, 0),
    n_source = replace_na(n_source, 0),
    n_total = n_hh + n_source,
    time_range = paste0(format(start, "%H:%M"), " - ", format(end, "%H:%M"), "<br>(", n_hh, " hh / ", n_source, " ws)")
  ) %>%
  select(surveyor_name, survey_date, time_range, n_total, n_hh, n_source)

week_totals <- household_data %>%
  filter(survey_date >= Sys.Date() - 7) %>%
  count(surveyor_name, name = "hh_week") %>%
  full_join(
    source_data %>%
      filter(survey_date >= Sys.Date() - 7) %>%
      count(surveyor_name, name = "source_week"),
    by = "surveyor_name"
  ) %>%
  replace_na(list(hh_week = 0, source_week = 0))

month_totals <- household_data %>%
  filter(survey_date >= Sys.Date() - 30) %>%
  count(surveyor_name, name = "hh_month") %>%
  full_join(
    source_data %>%
      filter(survey_date >= Sys.Date() - 30) %>%
      count(surveyor_name, name = "source_month"),
    by = "surveyor_name"
  ) %>%
  replace_na(list(hh_month = 0, source_month = 0))

combined_times <- combined_times_raw %>%
  complete(surveyor_name, survey_date = all_dates, fill = list(time_range = "", n_total = 0, n_hh = 0, n_source = 0)) %>%
  left_join(week_totals, by = "surveyor_name") %>%
  left_join(month_totals, by = "surveyor_name") %>%
  replace_na(list(hh_week = 0, source_week = 0, hh_month = 0, source_month = 0)) %>%
  mutate(surveyor_name = factor(surveyor_name, 
                          levels = c("Abdulai K", "Abdulai B", "Jamiatu", "Boboieh", 
                                    "Joseph", "Moses", "Musa", "Joana", "Other"))) %>%
  arrange(surveyor_name) %>%
  group_by(surveyor_name) %>%
  filter(any(n_total > 0)) %>%
  ungroup()

# Grand total
grand_daily <- household_data %>%
  count(survey_date, name = "n_hh") %>%
  full_join(
    source_data %>%
      count(survey_date, name = "n_source"),
    by = "survey_date"
  ) %>%
  replace_na(list(n_hh = 0, n_source = 0))

grand_week <- household_data %>%
  filter(survey_date >= Sys.Date() - 7) %>%
  summarise(hh_week = n()) %>%
  bind_cols(
    source_data %>%
      filter(survey_date >= Sys.Date() - 7) %>%
      summarise(source_week = n())
  ) %>%
  replace_na(list(hh_week = 0, source_week = 0))

grand_month <- household_data %>%
  filter(survey_date >= Sys.Date() - 30) %>%
  summarise(hh_month = n()) %>%
  bind_cols(
    source_data %>%
      filter(survey_date >= Sys.Date() - 30) %>%
      summarise(source_month = n())
  ) %>%
  replace_na(list(hh_month = 0, source_month = 0))

grand_total <- grand_daily %>%
  mutate(
    n_total = NA,
    time_range = paste0("(", n_hh, " hh / ", n_source, " ws)"),
    surveyor_name = "GRAND TOTAL",
    hh_week = grand_week$hh_week,
    source_week = grand_week$source_week,
    hh_month = grand_month$hh_month,
    source_month = grand_month$source_month
  ) %>%
  select(surveyor_name, survey_date, time_range, n_total, hh_week, source_week, hh_month, source_month)

# Portee Rokupa subtotal
portee_daily <- household_data %>%
  filter(community == "Portee Rokupa") %>%
  count(survey_date, name = "n_hh") %>%
  full_join(
    source_data %>%
      filter(community == "Portee Rokupa") %>%
      count(survey_date, name = "n_source"),
    by = "survey_date"
  ) %>%
  replace_na(list(n_hh = 0, n_source = 0))

portee_week <- household_data %>%
  filter(survey_date >= Sys.Date() - 7, community == "Portee Rokupa") %>%
  summarise(hh_week = n()) %>%
  bind_cols(
    source_data %>%
      filter(survey_date >= Sys.Date() - 7, community == "Portee Rokupa") %>%
      summarise(source_week = n())
  ) %>%
  replace_na(list(hh_week = 0, source_week = 0))

portee_month <- household_data %>%
  filter(survey_date >= Sys.Date() - 30, community == "Portee Rokupa") %>%
  summarise(hh_month = n()) %>%
  bind_cols(
    source_data %>%
      filter(survey_date >= Sys.Date() - 30, community == "Portee Rokupa") %>%
      summarise(source_month = n())
  ) %>%
  replace_na(list(hh_month = 0, source_month = 0))

portee_subtotal <- portee_daily %>%
  mutate(
    n_total = NA,
    time_range = paste0("(", n_hh, " hh / ", n_source, " ws)"),
    surveyor_name = "Portee Rokupa Total",
    hh_week = portee_week$hh_week,
    source_week = portee_week$source_week,
    hh_month = portee_month$hh_month,
    source_month = portee_month$source_month
  ) %>%
  select(surveyor_name, survey_date, time_range, n_total, hh_week, source_week, hh_month, source_month)

# Dworzark subtotal
dworzark_daily <- household_data %>%
  filter(community == "Dworzark") %>%
  count(survey_date, name = "n_hh") %>%
  full_join(
    source_data %>%
      filter(community == "Dworzark") %>%
      count(survey_date, name = "n_source"),
    by = "survey_date"
  ) %>%
  replace_na(list(n_hh = 0, n_source = 0))

dworzark_week <- household_data %>%
  filter(survey_date >= Sys.Date() - 7, community == "Dworzark") %>%
  summarise(hh_week = n()) %>%
  bind_cols(
    source_data %>%
      filter(survey_date >= Sys.Date() - 7, community == "Dworzark") %>%
      summarise(source_week = n())
  ) %>%
  replace_na(list(hh_week = 0, source_week = 0))

dworzark_month <- household_data %>%
  filter(survey_date >= Sys.Date() - 30, community == "Dworzark") %>%
  summarise(hh_month = n()) %>%
  bind_cols(
    source_data %>%
      filter(survey_date >= Sys.Date() - 30, community == "Dworzark") %>%
      summarise(source_month = n())
  ) %>%
  replace_na(list(hh_month = 0, source_month = 0))

dworzark_subtotal <- dworzark_daily %>%
  mutate(
    n_total = NA,
    time_range = paste0("(", n_hh, " hh / ", n_source, " ws)"),
    surveyor_name = "Dworzark Total",
    hh_week = dworzark_week$hh_week,
    source_week = dworzark_week$source_week,
    hh_month = dworzark_month$hh_month,
    source_month = dworzark_month$source_month
  ) %>%
  select(surveyor_name, survey_date, time_range, n_total, hh_week, source_week, hh_month, source_month)

# Cockle Bay subtotal
cockle_daily <- household_data %>%
  filter(community == "Cockle Bay") %>%
  count(survey_date, name = "n_hh") %>%
  full_join(
    source_data %>%
      filter(community == "Cockle Bay") %>%
      count(survey_date, name = "n_source"),
    by = "survey_date"
  ) %>%
  replace_na(list(n_hh = 0, n_source = 0))

cockle_week <- household_data %>%
  filter(survey_date >= Sys.Date() - 7, community == "Cockle Bay") %>%
  summarise(hh_week = n()) %>%
  bind_cols(
    source_data %>%
      filter(survey_date >= Sys.Date() - 7, community == "Cockle Bay") %>%
      summarise(source_week = n())
  ) %>%
  replace_na(list(hh_week = 0, source_week = 0))

cockle_month <- household_data %>%
  filter(survey_date >= Sys.Date() - 30, community == "Cockle Bay") %>%
  summarise(hh_month = n()) %>%
  bind_cols(
    source_data %>%
      filter(survey_date >= Sys.Date() - 30, community == "Cockle Bay") %>%
      summarise(source_month = n())
  ) %>%
  replace_na(list(hh_month = 0, source_month = 0))

cockle_subtotal <- cockle_daily %>%
  mutate(
    n_total = NA,
    time_range = paste0("(", n_hh, " hh / ", n_source, " ws)"),
    surveyor_name = "Cockle Bay Total",
    hh_week = cockle_week$hh_week,
    source_week = cockle_week$source_week,
    hh_month = cockle_month$hh_month,
    source_month = cockle_month$source_month
  ) %>%
  select(surveyor_name, survey_date, time_range, n_total, hh_week, source_week, hh_month, source_month)

# Color function (weekend logic, blank for 0 total)
apply_color <- function(text, n_total, date) {
  if (is.na(n_total) || n_total == 0) return("")
  
  is_weekend <- weekdays(date) %in% c("Saturday", "Sunday")
  
  if (is_weekend) {
    if (n_total > 10) {
      paste0('<span style="background-color: #ccffcc; display: block;">', text, '</span>')
    } else {
      text
    }
  } else {
    case_when(
      n_total < 8 ~ paste0('<span style="background-color: #ffcccc; display: block;">', text, '</span>'),
      n_total > 10 ~ paste0('<span style="background-color: #ccffcc; display: block;">', text, '</span>'),
      TRUE ~ text
    )
  }
}

# Combine counts only (no times, blank for 0)
combined_times_final <- combined_times %>%
  select(surveyor_name, survey_date, n_total, n_hh, n_source,
         hh_week, source_week, hh_month, source_month) %>%
  mutate(
    count_text = ifelse(n_total > 0, paste0("(", n_hh, " hh / ", n_source, " ws)"), "")
  ) %>%
  bind_rows(
    grand_total %>% mutate(count_text = ifelse(n_total > 0, time_range, "")) %>%
      select(surveyor_name, survey_date, n_total, hh_week, source_week, hh_month, source_month, count_text),
    portee_subtotal %>% rename(count_text = time_range),
    dworzark_subtotal %>% rename(count_text = time_range),
    cockle_subtotal %>% rename(count_text = time_range)
  ) %>%
  mutate(
    count_text = mapply(apply_color, count_text, n_total, survey_date),
    totals = paste0(
      "Week: ", hh_week, " hh / ", source_week, " ws<br>",
      "Month: ", hh_month, " hh / ", source_month, " ws"
    ),
    surveyor_name = factor(
      surveyor_name,
      levels = c(
        "GRAND TOTAL",
        "Abdulai K", "Abdulai B", "Portee Rokupa Total",
        "Jamiatu", "Boboieh", "Joseph", "Moses", "Dworzark Total",
        "Musa", "Joana", "Other", "Cockle Bay Total"
      )
    )
  ) %>%
  arrange(surveyor_name) %>%
  select(surveyor_name, totals, survey_date, count_text) %>%
  pivot_wider(
    names_from = survey_date,
    values_from = count_text,
    values_fill = ""
  ) %>%
  select(surveyor_name, totals, all_of(as.character(all_dates)))

# Identify Sunday columns
sunday_cols <- which(weekdays(as.Date(all_dates)) == "Sunday") + 2  # +2 because first column = Surveyor, second = Totals

# Render table with vertical lines after Sundays and Totals
tbl <- combined_times_final %>%
  kable(
    col.names = c("Surveyor", "Totals", format(all_dates, "%a %b %d")),
    escape = FALSE,
    format = "html",
    align = c("l", "c", rep("c", length(all_dates)))
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover"),
    full_width = FALSE,
    position = "left",
    fixed_thead = TRUE,
    
  ) %>%
  row_spec(
    which(combined_times_final$surveyor_name %in%
            c("GRAND TOTAL", "Portee Rokupa Total",
              "Dworzark Total", "Cockle Bay Total")),
    bold = TRUE,
    background = "#f0f0f0",
    extra_css = "white-space: nowrap; vertical-align: middle;"
  ) %>%
  row_spec(0, extra_css = "white-space: nowrap;")%>%
  column_spec(2:ncol(combined_times_final), extra_css = "white-space: nowrap; vertical-align: middle;") %>%
  column_spec(2, extra_css = "border-right: 2px solid black; white-space: nowrap; vertical-align: middle;")

# Add right border after Sundays
for (col in sunday_cols) {
  tbl <- tbl %>% column_spec(col, extra_css = "border-left: 2px solid black; white-space: nowrap; vertical-align: middle;")
}

tbl
```
