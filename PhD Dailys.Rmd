---
title: "Survey Daily Report"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  html_document:
    theme: flatly
    toc: true
    toc_float: true
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_file = 'index.html'
    )
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(lubridate)
library(knitr)
library(scales)
library(httr)
library(jsonlite)
library(kableExtra)
library(sf)
library(ggspatial)
library(gridExtra)
library(grid)
library(gtable)
library(prettymapr)

kobo_token <- Sys.getenv("KOBO_TOKEN")

# Household survey
form_id_household <- "a7WdSwwL7Zug9hC98x5PRd"
# Water source survey
form_id_source <- "aDnYgCWxBduEXrC6cFzCP2"

base_url <- "https://kf.kobotoolbox.org/api/v2/assets/"

# Get household data
response_household <- GET(
  paste0(base_url, form_id_household, "/data.json"),
  add_headers(Authorization = paste("Token", kobo_token))
)

data_list_household <- content(response_household, as = "parsed", simplifyDataFrame = TRUE)
household_data <- as.data.frame(data_list_household$results)

names(household_data) <- names(household_data) %>%
  sub(".*/", "", .) %>%
  sub("^_", "", .)

household_data <- household_data[, !duplicated(names(household_data))]

household_data <- household_data %>%
  mutate(start_time = ymd_hms(start_time, tz = "UTC")) %>%
  mutate(end_time = ymd_hms(end_time, tz = "UTC")) %>%
  mutate(survey_date = as.Date(start_time)) %>%
  mutate(date_label = format(survey_date, "%b %d"))

numeric_vars_household <- c("adult_men", "adult_women", "boys", "girls", "school_age_boys", 
  "school_age_girls", "boys_attend_school", "girls_attend_school",
  "drinking_water_daily_spend", "domestic_water_daily_spend",
  "drinking_walk_time", "drinking_wait_time", "drinking_trips",
  "domestic_walk_time", "domestic_wait_time", "domestic_trips",
  "sources_access", "sources_used", "daily_helpers", "jerrycans_men",
  "jerrycans_women", "jerrycans_boys", "jerrycans_girls", "jerrycans_hired",
  "boys_late_school", "girls_late_school", "stored_amount", "sick_water",
  "injuries_water")

household_data <- household_data %>%
  mutate(across(all_of(numeric_vars_household[numeric_vars_household %in% names(household_data)]), as.numeric))

household_data$community <- factor(household_data$community,
                              levels = c("cockle", "dworzark", "portee"),
                              labels = c("Cockle Bay", "Dworzark", "Portee Rokupa"))

household_data$surveyor_name <- factor(household_data$surveyor_name,
                                  levels = c("abdulaib", "abdulaik", "boboieh", "jamiatu", "musa", "joana", "moses", "joseph", "other"),
                                  labels = c("Abdulai B", "Abdulai K", "Boboieh", "Jamiatu", "Musa", "Joana", "Moses", "Joseph", "Other"))

household_data$survey_month <- factor(household_data$survey_month,
                                 levels = c("november", "december", "january", "february", "march", "april", "may", "june", "july", "august", "september", "october"),
                                 labels = c("November", "December", "January", "February", "March", "April", "May", "June", "July", "August", "September", "October"))

# Get water source data
response_source <- GET(
  paste0(base_url, form_id_source, "/data.json"),
  add_headers(Authorization = paste("Token", kobo_token))
)

data_list_source <- content(response_source, as = "parsed", simplifyDataFrame = TRUE)
source_data <- as.data.frame(data_list_source$results)

names(source_data) <- names(source_data) %>%
  sub(".*/", "", .) %>%
  sub("^_", "", .)

source_data <- source_data[, !duplicated(names(source_data))]

source_data <- source_data %>%
  mutate(start_time = ymd_hms(start_time, tz = "UTC")) %>%
  mutate(end_time = ymd_hms(end_time, tz = "UTC")) %>%
  mutate(survey_date = as.Date(start_time)) %>%
  mutate(date_label = format(survey_date, "%b %d"))

if("consent" %in% names(source_data)) {
  source_data <- source_data %>% filter(consent == "yes")
}

numeric_vars_source <- c("percent_women_gatherers", "price_per_jerrycan", "price_per_month")

source_data <- source_data %>%
  mutate(across(all_of(numeric_vars_source[numeric_vars_source %in% names(source_data)]), as.numeric))

source_data$community <- factor(source_data$community,
                      levels = c("cockle_bay", "dworzark", "portee_rokupa"),
                      labels = c("Cockle Bay", "Dworzark", "Portee Rokupa"))

source_data$surveyor_name <- factor(source_data$surveyor_name,
                                  levels = c("abdulaib", "abdulaik", "boboieh", "jamiatu", "musa", "joana", "moses", "joseph", "other"),
                                  labels = c("Abdulai B", "Abdulai K", "Boboieh", "Jamiatu", "Musa", "Joana", "Moses", "Joseph", "Other"))

```

```{r}
# Define target surveys per community
targets <- tibble(
  community = c("Portee Rokupa", "Dworzark", "Cockle Bay"),
  target = c(170, 340, 170)
)

# Count completed household surveys by community
completed <- household_data %>%
  count(community, name = "completed")

# Calculate remaining surveys
community_progress <- targets %>%
  left_join(completed, by = "community") %>%
  replace_na(list(completed = 0)) %>%
  mutate(remaining = target - completed)
```

**Portee Rokupa**: `r community_progress$completed[community_progress$community == "Portee Rokupa"]`/`r community_progress$target[community_progress$community == "Portee Rokupa"]` surveys completed, `r community_progress$remaining[community_progress$community == "Portee Rokupa"]` remaining

**Dworzark**: `r community_progress$completed[community_progress$community == "Dworzark"]`/`r community_progress$target[community_progress$community == "Dworzark"]` surveys completed, `r community_progress$remaining[community_progress$community == "Dworzark"]` remaining

**Cockle Bay**: `r community_progress$completed[community_progress$community == "Cockle Bay"]`/`r community_progress$target[community_progress$community == "Cockle Bay"]` surveys completed, `r community_progress$remaining[community_progress$community == "Cockle Bay"]` remaining

# Recent Performance ####

```{r}
last_4_days <- sort(unique(household_data$survey_date), decreasing = TRUE)[1:4]

household_times <- household_data %>%
  filter(survey_date %in% last_4_days) %>%
  group_by(surveyor_name, survey_date) %>%
  summarise(
    start = min(start_time),
    end = max(end_time),
    n_hh = n(),
    .groups = "drop"
  )

source_counts <- source_data %>%
  filter(survey_date %in% last_4_days) %>%
  count(surveyor_name, survey_date, name = "n_source")

week_totals <- household_data %>%
  filter(survey_date >= Sys.Date() - 7) %>%
  count(surveyor_name, name = "hh_week") %>%
  left_join(
    source_data %>%
      filter(survey_date >= Sys.Date() - 7) %>%
      count(surveyor_name, name = "source_week"),
    by = "surveyor_name"
  ) %>%
  replace_na(list(source_week = 0))

month_totals <- household_data %>%
  filter(survey_date >= Sys.Date() - 30) %>%
  count(surveyor_name, name = "hh_month") %>%
  left_join(
    source_data %>%
      filter(survey_date >= Sys.Date() - 30) %>%
      count(surveyor_name, name = "source_month"),
    by = "surveyor_name"
  ) %>%
  replace_na(list(source_month = 0))

combined_times <- household_times %>%
  left_join(source_counts, by = c("surveyor_name", "survey_date")) %>%
  replace_na(list(n_source = 0)) %>%
  mutate(
    n_total = n_hh + n_source,
    time_range = paste0(format(start, "%H:%M"), " - ", format(end, "%H:%M"), "<br>(", n_hh, " hh / ", n_source, " ws)")
  ) %>%
  select(surveyor_name, survey_date, time_range, n_total) %>%
  complete(surveyor_name, survey_date = last_4_days, fill = list(time_range = "", n_total = 0)) %>%
  left_join(week_totals, by = "surveyor_name") %>%
  left_join(month_totals, by = "surveyor_name") %>%
  replace_na(list(hh_week = 0, source_week = 0, hh_month = 0, source_month = 0)) %>%
  mutate(surveyor_name = factor(surveyor_name, 
                          levels = c("Abdulai K", "Abdulai B", "Jamiatu", "Boboieh", 
                                    "Joseph", "Moses", "Musa", "Joana", "Other"))) %>%
  arrange(surveyor_name)

# Grand total
grand_daily <- household_data %>%
  filter(survey_date %in% last_4_days) %>%
  count(survey_date, name = "n_hh") %>%
  left_join(
    source_data %>%
      filter(survey_date %in% last_4_days) %>%
      count(survey_date, name = "n_source"),
    by = "survey_date"
  ) %>%
  replace_na(list(n_source = 0))

grand_week <- household_data %>%
  filter(survey_date >= Sys.Date() - 7) %>%
  summarise(hh_week = n()) %>%
  left_join(
    source_data %>%
      filter(survey_date >= Sys.Date() - 7) %>%
      summarise(source_week = n()),
    by = character()
  ) %>%
  replace_na(list(source_week = 0))

grand_month <- household_data %>%
  filter(survey_date >= Sys.Date() - 30) %>%
  summarise(hh_month = n()) %>%
  left_join(
    source_data %>%
      filter(survey_date >= Sys.Date() - 30) %>%
      summarise(source_month = n()),
    by = character()
  ) %>%
  replace_na(list(source_month = 0))

grand_total <- grand_daily %>%
  mutate(
    n_total = NA,
    time_range = paste0("(", n_hh, " hh / ", n_source, " ws)"),
    surveyor_name = "GRAND TOTAL",
    hh_week = grand_week$hh_week,
    source_week = grand_week$source_week,
    hh_month = grand_month$hh_month,
    source_month = grand_month$source_month
  ) %>%
  select(surveyor_name, survey_date, time_range, n_total, hh_week, source_week, hh_month, source_month)

# Portee Rokupa subtotal
portee_daily <- household_data %>%
  filter(survey_date %in% last_4_days, community == "Portee Rokupa") %>%
  count(survey_date, name = "n_hh") %>%
  left_join(
    source_data %>%
      filter(survey_date %in% last_4_days, community == "Portee Rokupa") %>%
      count(survey_date, name = "n_source"),
    by = "survey_date"
  ) %>%
  replace_na(list(n_source = 0))

portee_week <- household_data %>%
  filter(survey_date >= Sys.Date() - 7, community == "Portee Rokupa") %>%
  summarise(hh_week = n()) %>%
  left_join(
    source_data %>%
      filter(survey_date >= Sys.Date() - 7, community == "Portee Rokupa") %>%
      summarise(source_week = n()),
    by = character()
  ) %>%
  replace_na(list(source_week = 0))

portee_month <- household_data %>%
  filter(survey_date >= Sys.Date() - 30, community == "Portee Rokupa") %>%
  summarise(hh_month = n()) %>%
  left_join(
    source_data %>%
      filter(survey_date >= Sys.Date() - 30, community == "Portee Rokupa") %>%
      summarise(source_month = n()),
    by = character()
  ) %>%
  replace_na(list(source_month = 0))

portee_subtotal <- portee_daily %>%
  mutate(
    n_total = NA,
    time_range = paste0("(", n_hh, " hh / ", n_source, " ws)"),
    surveyor_name = "Portee Rokupa Total",
    hh_week = portee_week$hh_week,
    source_week = portee_week$source_week,
    hh_month = portee_month$hh_month,
    source_month = portee_month$source_month
  ) %>%
  select(surveyor_name, survey_date, time_range, n_total, hh_week, source_week, hh_month, source_month)

# Dworzark subtotal
dworzark_daily <- household_data %>%
  filter(survey_date %in% last_4_days, community == "Dworzark") %>%
  count(survey_date, name = "n_hh") %>%
  left_join(
    source_data %>%
      filter(survey_date %in% last_4_days, community == "Dworzark") %>%
      count(survey_date, name = "n_source"),
    by = "survey_date"
  ) %>%
  replace_na(list(n_source = 0))

dworzark_week <- household_data %>%
  filter(survey_date >= Sys.Date() - 7, community == "Dworzark") %>%
  summarise(hh_week = n()) %>%
  left_join(
    source_data %>%
      filter(survey_date >= Sys.Date() - 7, community == "Dworzark") %>%
      summarise(source_week = n()),
    by = character()
  ) %>%
  replace_na(list(source_week = 0))

dworzark_month <- household_data %>%
  filter(survey_date >= Sys.Date() - 30, community == "Dworzark") %>%
  summarise(hh_month = n()) %>%
  left_join(
    source_data %>%
      filter(survey_date >= Sys.Date() - 30, community == "Dworzark") %>%
      summarise(source_month = n()),
    by = character()
  ) %>%
  replace_na(list(source_month = 0))

dworzark_subtotal <- dworzark_daily %>%
  mutate(
    n_total = NA,
    time_range = paste0("(", n_hh, " hh / ", n_source, " ws)"),
    surveyor_name = "Dworzark Total",
    hh_week = dworzark_week$hh_week,
    source_week = dworzark_week$source_week,
    hh_month = dworzark_month$hh_month,
    source_month = dworzark_month$source_month
  ) %>%
  select(surveyor_name, survey_date, time_range, n_total, hh_week, source_week, hh_month, source_month)

# Cockle Bay subtotal
cockle_daily <- household_data %>%
  filter(survey_date %in% last_4_days, community == "Cockle Bay") %>%
  count(survey_date, name = "n_hh") %>%
  left_join(
    source_data %>%
      filter(survey_date %in% last_4_days, community == "Cockle Bay") %>%
      count(survey_date, name = "n_source"),
    by = "survey_date"
  ) %>%
  replace_na(list(n_source = 0))

cockle_week <- household_data %>%
  filter(survey_date >= Sys.Date() - 7, community == "Cockle Bay") %>%
  summarise(hh_week = n()) %>%
  left_join(
    source_data %>%
      filter(survey_date >= Sys.Date() - 7, community == "Cockle Bay") %>%
      summarise(source_week = n()),
    by = character()
  ) %>%
  replace_na(list(source_week = 0))

cockle_month <- household_data %>%
  filter(survey_date >= Sys.Date() - 30, community == "Cockle Bay") %>%
  summarise(hh_month = n()) %>%
  left_join(
    source_data %>%
      filter(survey_date >= Sys.Date() - 30, community == "Cockle Bay") %>%
      summarise(source_month = n()),
    by = character()
  ) %>%
  replace_na(list(source_month = 0))

cockle_subtotal <- cockle_daily %>%
  mutate(
    n_total = NA,
    time_range = paste0("(", n_hh, " hh / ", n_source, " ws)"),
    surveyor_name = "Cockle Bay Total",
    hh_week = cockle_week$hh_week,
    source_week = cockle_week$source_week,
    hh_month = cockle_month$hh_month,
    source_month = cockle_month$source_month
  ) %>%
  select(surveyor_name, survey_date, time_range, n_total, hh_week, source_week, hh_month, source_month)

# Apply color function
apply_color <- function(text, n_total) {
  if (is.na(n_total)) {
    return(text)
  }
  case_when(
    n_total == 0 ~ paste0('<span style="background-color: #ff9999; display: block;">', text, '</span>'),
    n_total < 8 ~ paste0('<span style="background-color: #ffcccc; display: block;">', text, '</span>'),
    n_total > 10 ~ paste0('<span style="background-color: #ccffcc; display: block;">', text, '</span>'),
    TRUE ~ text
  )
}

combined_times_final <- combined_times %>%
  select(surveyor_name, survey_date, time_range, n_total, hh_week, source_week, hh_month, source_month) %>%
  bind_rows(grand_total, portee_subtotal, dworzark_subtotal, cockle_subtotal) %>%
  mutate(
    time_range = mapply(apply_color, time_range, n_total),
    totals = paste0("Week: ", hh_week, " hh / ", source_week, " ws<br>Month: ", hh_month, " hh / ", source_month, " ws"),
    surveyor_name = factor(surveyor_name, 
                          levels = c("GRAND TOTAL",
                                    "Abdulai K", "Abdulai B", "Portee Rokupa Total",
                                    "Jamiatu", "Boboieh", "Joseph", "Moses", "Dworzark Total",
                                    "Musa", "Joana", "Other", "Cockle Bay Total"))
  ) %>%
  arrange(surveyor_name) %>%
  select(surveyor_name, survey_date, time_range, totals) %>%
  pivot_wider(names_from = survey_date, values_from = time_range, values_fill = "") %>%
  select(surveyor_name, all_of(as.character(last_4_days)), totals)

combined_times_final %>%
  kable(col.names = c("Surveyor", format(last_4_days, "%a %b %d"), "Totals"), escape = FALSE, format = "html", align = c("l", rep("c", 5))) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  row_spec(which(combined_times_final$surveyor_name %in% c("GRAND TOTAL", "Portee Rokupa Total", "Dworzark Total", "Cockle Bay Total")), bold = TRUE, background = "#f0f0f0")

```

# Work Days ####

```{r}
combined_monthly <- bind_rows(
  household_data %>% mutate(survey_type = "household"),
  source_data %>% mutate(survey_type = "source")
) %>%
  filter(month(survey_date) == month(Sys.Date()), year(survey_date) == year(Sys.Date())) %>%
  count(surveyor_name, survey_date) %>%
  complete(surveyor_name, survey_date, fill = list(n = 0)) %>%
  pivot_wider(names_from = survey_date, values_from = n, values_fill = 0)

month_dates <- sort(unique(combined_monthly %>% select(-surveyor_name) %>% names() %>% as.Date()))
month_name <- format(Sys.Date(), "%B")

combined_summary <- combined_monthly %>%
  mutate(`Month Total` = rowSums(select(., -surveyor_name))) %>%
  mutate(surveyor_name = factor(surveyor_name, 
                                levels = c("Abdulai K", "Abdulai B", "Jamiatu", "Boboieh", 
                                          "Joseph", "Moses", "Musa", "Joana", "Other"))) %>%
  arrange(surveyor_name)

total_row_combined <- combined_summary %>%
  summarise(across(-surveyor_name, sum)) %>%
  mutate(surveyor_name = "TOTAL", .before = 1)

final_table <- combined_summary %>%
  bind_rows(total_row_combined)

# Create a function to apply colors based on value
apply_color <- function(x) {
  case_when(
    x == 0 ~ paste0('<span style="background-color: #ff9999; display: block; text-align: center;">', x, '</span>'),
    x < 8 ~ paste0('<span style="background-color: #ffcccc; display: block; text-align: center;">', x, '</span>'),
    x > 10 ~ paste0('<span style="background-color: #ccffcc; display: block; text-align: center;">', x, '</span>'),
    TRUE ~ as.character(x)
  )
}

# Apply colors to date columns
final_table_colored <- final_table %>%
  mutate(across(2:(ncol(final_table)-1), apply_color))

final_table_colored %>%
  kable(col.names = c("Surveyor", format(month_dates, "%a %b %d"), "Month Total"),
        caption = paste0("<center><h3>Total Surveys of Any Kind in ", month_name, "</h3></center>"),
        escape = FALSE, format = "html", align = c("l", rep("c", ncol(final_table_colored)-1))) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  row_spec(nrow(combined_summary) + 1, bold = TRUE, background = "#e8e8e8")
```

# Mapping ####

## Portee Rokupa Map ####
```{r, fig.height=10}
# Read the shapefile
portee_shapefile <- st_read("shapefiles/PorteeRokupa.shp", quiet = TRUE)

# Transform shapefile to WGS84 if needed
portee_shapefile_wgs84 <- st_transform(portee_shapefile, crs = 4326)

# Combine household and water source data for Portee Rokupa
portee_surveys <- bind_rows(
  household_data %>% 
    filter(community == "Portee Rokupa") %>%
    select(community, survey_date, surveyor_name, gps_location) %>%
    mutate(survey_type = "Household"),
  source_data %>% 
    filter(community == "Portee Rokupa") %>%
    select(community, survey_date, surveyor_name, gps_location) %>%
    mutate(survey_type = "Water Source")
) %>%
  filter(!is.na(gps_location)) %>%
  separate(gps_location, into = c("latitude", "longitude", "altitude", "accuracy"), 
           sep = " ", remove = FALSE, convert = TRUE) %>%
  filter(!is.na(latitude), !is.na(longitude)) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

# Transform to a projected CRS for distance calculation (UTM zone for Sierra Leone)
portee_surveys_utm <- st_transform(portee_surveys, crs = 32628)
portee_shapefile_utm <- st_transform(portee_shapefile_wgs84, crs = 32628)

# Calculate distance from each point to the shapefile boundary
distances <- st_distance(portee_surveys_utm, portee_shapefile_utm)

# Filter points within 100m of the shapefile
portee_surveys_filtered <- portee_surveys[as.numeric(distances) <= 100, ]

# Continue with the rest of the code using filtered data
portee_surveys_filtered <- portee_surveys_filtered %>%
  mutate(
    day_name = factor(weekdays(survey_date), 
                     levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
    surveyor_type = case_when(
      surveyor_name == "Abdulai K" ~ "Abdulai K",
      surveyor_name == "Abdulai B" ~ "Abdulai B",
      TRUE ~ "Other Surveyor"
    ),
    outline_color = case_when(
      surveyor_name == "Abdulai K" ~ "black",
      surveyor_name == "Abdulai B" ~ "white",
      TRUE ~ "gray"
    ),
    is_recent = survey_date >= Sys.Date() - 7,
    alpha_value = ifelse(is_recent, 1, 0.7),
    size_value = ifelse(is_recent, 3, 2)
  )

# Define day colors (rainbow order: red through purple, grey for Sunday)
day_colors <- c(
  "Monday" = "#FF0000",      # Red
  "Tuesday" = "#FF7F00",     # Orange
  "Wednesday" = "#FFFF00",   # Yellow
  "Thursday" = "#00FF00",    # Green
  "Friday" = "#0000FF",      # Blue
  "Saturday" = "#8B00FF",    # Purple
  "Sunday" = "#808080"       # Grey
)

# Define shapes for survey types
survey_shapes <- c("Household" = 21, "Water Source" = 24)

# Define outline colors
outline_colors <- c("Abdulai K" = "black", "Abdulai B" = "white", "Other Surveyor" = "gray")

# Portee Rokupa map
ggplot() +
  annotation_map_tile(type = "osm", zoomin = 0, progress = "none") +
  geom_sf(data = portee_shapefile_wgs84, fill = NA, color = "black", linewidth = 1) +
  geom_sf(data = portee_surveys_filtered, aes(fill = day_name, shape = survey_type, color = surveyor_type, alpha = alpha_value, size = size_value), 
          stroke = 1) +
  scale_fill_manual(values = day_colors) +
  scale_shape_manual(values = survey_shapes) +
  scale_color_manual(values = outline_colors) +
  scale_alpha_identity() +
  scale_size_identity() +
  labs(title = "All Surveys in Portee Rokupa", fill = "Day", shape = "Survey Type", color = "Surveyor") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()) +
  guides(
    fill = guide_legend(override.aes = list(shape = 21, color = "black", size = 3, alpha = 1, stroke = 1)),
    shape = guide_legend(override.aes = list(fill = "gray", color = "black", size = 3, alpha = 1, stroke = 1)),
    color = guide_legend(override.aes = list(fill = "gray", shape = 21, size = 3, alpha = 1, stroke = 1))
  )
```

## Dworzark Map ####

```{r, fig.height=10, fig.width=8}
# Read the shapefile
dworzark_shapefile <- st_read("shapefiles/Dworzark.shp", quiet = TRUE)

# Transform shapefile to WGS84 if needed
dworzark_shapefile_wgs84 <- st_transform(dworzark_shapefile, crs = 4326)

# Combine household and water source data for Dworzark
dworzark_surveys <- bind_rows(
  household_data %>% 
    filter(community == "Dworzark") %>%
    select(community, survey_date, surveyor_name, gps_location) %>%
    mutate(survey_type = "Household"),
  source_data %>% 
    filter(community == "Dworzark") %>%
    select(community, survey_date, surveyor_name, gps_location) %>%
    mutate(survey_type = "Water Source")
) %>%
  filter(!is.na(gps_location)) %>%
  separate(gps_location, into = c("latitude", "longitude", "altitude", "accuracy"), 
           sep = " ", remove = FALSE, convert = TRUE) %>%
  filter(!is.na(latitude), !is.na(longitude)) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

# Transform to a projected CRS for distance calculation (UTM zone for Sierra Leone)
dworzark_surveys_utm <- st_transform(dworzark_surveys, crs = 32628)
dworzark_shapefile_utm <- st_transform(dworzark_shapefile_wgs84, crs = 32628)

# Calculate distance from each point to the shapefile boundary
distances <- st_distance(dworzark_surveys_utm, dworzark_shapefile_utm)

# Filter points within 100m of the shapefile
dworzark_surveys_filtered <- dworzark_surveys[as.numeric(distances) <= 100, ]

# Continue with the rest of the code using filtered data
dworzark_surveys_filtered <- dworzark_surveys_filtered %>%
  mutate(
    day_name = factor(weekdays(survey_date), 
                     levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
    surveyor_type = case_when(
      surveyor_name == "Jamiatu" ~ "Jamiatu",
      surveyor_name == "Boboieh" ~ "Boboieh",
      surveyor_name == "Joseph" ~ "Joseph",
      surveyor_name == "Moses" ~ "Moses",
      TRUE ~ "Other Surveyor"
    ),
    outline_color = case_when(
      surveyor_name == "Jamiatu" ~ "black",
      surveyor_name == "Boboieh" ~ "white",
      surveyor_name == "Joseph" ~ "blue",
      surveyor_name == "Moses" ~ "red",
      TRUE ~ "gray"
    ),
    is_recent = survey_date >= Sys.Date() - 7,
    alpha_value = ifelse(is_recent, 1, 0.7),
    size_value = ifelse(is_recent, 3, 2)
  )

# Define day colors (rainbow order: red through purple, grey for Sunday)
day_colors <- c(
  "Monday" = "#FF0000",      # Red
  "Tuesday" = "#FF7F00",     # Orange
  "Wednesday" = "#FFFF00",   # Yellow
  "Thursday" = "#00FF00",    # Green
  "Friday" = "#0000FF",      # Blue
  "Saturday" = "#8B00FF",    # Purple
  "Sunday" = "#808080"       # Grey
)

# Define shapes for survey types
survey_shapes <- c("Household" = 21, "Water Source" = 24)

# Define outline colors
outline_colors <- c("Jamiatu" = "black", "Boboieh" = "white", "Joseph" = "blue", "Moses" = "red", "Other Surveyor" = "gray")

# Dworzark map
ggplot() +
  annotation_map_tile(type = "osm", zoomin = 0, progress = "none") +
  geom_sf(data = dworzark_shapefile_wgs84, fill = NA, color = "black", linewidth = 1) +
  geom_sf(data = dworzark_surveys_filtered, aes(fill = day_name, shape = survey_type, color = surveyor_type, alpha = alpha_value, size = size_value), 
          stroke = 1) +
  scale_fill_manual(values = day_colors) +
  scale_shape_manual(values = survey_shapes) +
  scale_color_manual(values = outline_colors) +
  scale_alpha_identity() +
  scale_size_identity() +
  labs(title = "All Surveys in Dworzark", fill = "Day", shape = "Survey Type", color = "Surveyor") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()) +
  guides(
    fill = guide_legend(override.aes = list(shape = 21, color = "black", size = 3, alpha = 1, stroke = 1)),
    shape = guide_legend(override.aes = list(fill = "gray", color = "black", size = 3, alpha = 1, stroke = 1)),
    color = guide_legend(override.aes = list(fill = "gray", shape = 21, size = 3, alpha = 1, stroke = 1))
  )
```

## Cockle Bay Map ####

```{r, fig.height=10}
# Read the shapefile
cockle_shapefile <- st_read("shapefiles/CockleBay.shp", quiet = TRUE)

# Combine household and water source data for Cockle Bay
cockle_surveys <- bind_rows(
  household_data %>% 
    filter(community == "Cockle Bay") %>%
    select(community, survey_date, surveyor_name, gps_location) %>%
    mutate(survey_type = "Household"),
  source_data %>% 
    filter(community == "Cockle Bay") %>%
    select(community, survey_date, surveyor_name, gps_location) %>%
    mutate(survey_type = "Water Source")
) %>%
  filter(!is.na(gps_location)) %>%
  separate(gps_location, into = c("latitude", "longitude", "altitude", "accuracy"), 
           sep = " ", remove = FALSE, convert = TRUE) %>%
  filter(!is.na(latitude), !is.na(longitude)) %>%
  mutate(
    day_name = factor(weekdays(survey_date), 
                     levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
    surveyor_type = ifelse(surveyor_name == "Musa", "Musa", "Other Surveyor"),
    outline_color = ifelse(surveyor_name == "Musa", "black", "white"),
    is_recent = survey_date >= Sys.Date() - 7,
    alpha_value = ifelse(is_recent, 1, 0.7),
    size_value = ifelse(is_recent, 3, 2)
  ) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

# Define day colors (rainbow order: red through purple, grey for Sunday)
day_colors <- c(
  "Monday" = "#FF0000",      # Red
  "Tuesday" = "#FF7F00",     # Orange
  "Wednesday" = "#FFFF00",   # Yellow
  "Thursday" = "#00FF00",    # Green
  "Friday" = "#0000FF",      # Blue
  "Saturday" = "#8B00FF",    # Purple
  "Sunday" = "#808080"       # Grey
)

# Define shapes for survey types
survey_shapes <- c("Household" = 21, "Water Source" = 24)

# Define outline colors
outline_colors <- c("Musa" = "black", "Other Surveyor" = "white")

# Cockle Bay map
ggplot() +
  annotation_map_tile(type = "osm", zoomin = 0, progress = "none") +
  geom_sf(data = cockle_shapefile, fill = NA, color = "black", linewidth = 1) +
  geom_sf(data = cockle_surveys, aes(fill = day_name, shape = survey_type, color = surveyor_type, alpha = alpha_value, size = size_value), 
          stroke = 1) +
  scale_fill_manual(values = day_colors) +
  scale_shape_manual(values = survey_shapes) +
  scale_color_manual(values = outline_colors) +
  scale_alpha_identity() +
  scale_size_identity() +
  labs(title = "All Surveys in Cockle Bay", fill = "Day", shape = "Survey Type", color = "Surveyor") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()) +
  guides(
    fill = guide_legend(override.aes = list(shape = 21, color = "black", size = 3, alpha = 1, stroke = 1)),
    shape = guide_legend(override.aes = list(fill = "gray", color = "black", size = 3, alpha = 1, stroke = 1)),
    color = guide_legend(override.aes = list(fill = "gray", shape = 21, size = 3, alpha = 1, stroke = 1))
  )
```
